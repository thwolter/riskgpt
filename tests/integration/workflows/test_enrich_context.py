from unittest.mock import patch

import pytest
from models.base import ResponseInfo

from src.models.common import BusinessContext
from src.models.workflows.context import (
    ExternalContextRequest,
    ExtractKeyPointsResponse,
)
from src.workflows.enrich_context import enrich_context


@pytest.fixture
def test_request():
    """Fixture to create a sample ExternalContextRequest."""
    return ExternalContextRequest(
        business_context=BusinessContext(
            project_id="AI-Driven Risk Management",
            project_description="A project focused on leveraging AI for risk management",
            domain_knowledge="artificial intelligence and risk assessment",
        ),
        focus_keywords=["supply"],
    )


@pytest.fixture
def mock_search_result():
    """Fixture to create a mock search result."""
    return [
        {
            "title": "Two New Chapters in Supply Chain Data-Driven Intelligence - The Maritime Executive",
            "url": "https://www.maritime-executive.com/editorials/two-new-chapters-in-supply-chain-data-driven-intelligence",
            "date": "Thu, 19 Jun 2025 03:35:21 GMT",
            "type": "news",
            "comment": "Two New Chapters in Supply Chain Data-Driven Intelligence\nPublished\nby\nMikael Lind et al.\n\nFrench Shipping Magnate Philippe Louis-Dreyfus Passes at 80\nPublished\nby\nThe Maritime Executive\n\nFormer NOAA Officials Call on Industry to Oppose Budget Cuts\nPublished\nby\nThe Maritime Executive\n\nMaritime NZ Charges KiwiRail Over Ro/Ro Grounding\nPublished\nby\nThe Maritime Executive\nTwo New Chapters in Supply Chain Data-Driven Intelligence\n\nPublished\nJun 18, 2025 11:35 PM by\nMikael Lind et al.\n[By Mikael Lind, Wolfgang Lehmacher, Xiuju Fu, Jens Lund-Nielsen]\nYears of extreme volatility, caused by pandemic shocks, trade wars, and climate-driven disruptions, have exposed the complexity of the world’s logistics networks. Thanks to the increasing availability of multi-source data and rapid advancements in AI technologies, we now have unprecedented opportunities to unravel the complexities of supply chain operations. By harnessing collective intelligence, organizations can drive both cost efficiencies and significant reductions in emissions.\nThe unveiling of project44’s next-generation Movement platform marks another step toward managing supply chain and logistics networks more effectively, which are often battered by volatility. With its promise of “Decision Intelligence,” a concept not new, Movement is an AI-powered engine designed to transform logistics data into actionable, automated outcomes. As the industry assesses this development, a parallel story is unfolding: the rise of the Virtual Watch Tower (VWT), an ecosystem comprising supply chain and logistics actors, co-creating a federated, community-driven digital backbone designed to enhance supply chain and transport resilience and sustainability, leveraging collective intelligence with multiple source data inputs from different partners.\nBoth innovations are ambitious, but their philosophies, architectures, and real-world impacts diverge in fundamental ways. This article explores these differences, drawing on concrete examples and the lived experience of industry actors, to ask: What kind of digital infrastructure does the supply chain truly need?\nThe Movement Platform’s Vision\nMovement by project44 weaves together a network of APIs, connecting over 240,000 carriers, 1,400 telematics partners, and 80+ TMS/ERP systems. The platform’s architecture is built on four layers: Connect, See, Act, and Automate. This design is not accidental. It reflects a deliberate shift from simply providing visibility, knowing where goods are in the transport chain, to enabling execution: booking shipments, rerouting in response to disruptions, and automating exception management.\nAt the heart of Movement is AI. The platform’s AI Data Quality Agents autonomously resolve data gaps, achieving compliance and reducing manual interventions. The AI Disruption Navigator identifies global events, such as strikes, natural disasters, and geopolitical shocks, and personalizes their impact on customers’ shipments. MO, the AI Supply Chain Assistant, enables users to query the system in natural language, thereby accelerating insight generation and decision-making.\nFord Motor Company credits project44 with delivering the “connected data foundation” for its transportation needs, enabling faster, more confident decisions. Eaton, a $25 billion multinational, notes that real-time visibility has expanded its capabilities and made daily execution more effective. Movement is an execution platform, designed to help enterprises move from reactive firefighting to proactive orchestration. The platform’s unified interface and APIs enable actors, such as shippers, carriers, and forwarders, to collaborate, resolve exceptions, and share data securely, regardless of the system or geography.\nThe Virtual Watch Tower: A Federated Backbone for Ecosystem Innovation\nWhile project44’s Movement advances the cause of execution-focused AI, the VWT represents a different philosophy: that the future of logistics lies in a federated digital infrastructure to achieve collective intelligence and improvements. Conceived in the wake of failed industry platforms like TradeLens, VWT is not a product but a public good, an open, neutral backbone governed by the very actors it serves.\nVWT’s architecture, co-created by ecosystem partners such as H&M, Scania, Transporeon (a Trimble company), PSA, and many others, is built on TWIN (Trade Worldwide Information Network), a federated, open-source digital infrastructure that enables secure, shipment-level data exchange. The core idea is simple but radical: shippers, as the originators of cargo flows, authorize the sharing of operational details for their shipments, allowing every actor in the chain, including ports, carriers, forwarders, and authorities, to access real-time, trusted, primary data. This transparency enables shared situational awareness, collaborative disruption management, improved carbon dioxide emission calculations, and ecosystem-level innovation.\nNo single company owns VWT or its digital infrastructure, VWTnet. The ecosystem and solution are currently stewarded by neutral research institutes, including RISE (Research Institutes of Sweden), ASTAR’s IHPC (Institute for High Performance Computing), Finland’s VTT, and Estonia’s TalTech. The plan is to establish a charity with a two-tier governance model:[i] strategic oversight by a foundation and technical co-development by a global network of technology providers. This structure ensures that VWT remains neutral, adaptable, and accountable to the entire industry, driving transparency which enables each actor to function as an independent intelligent agent contributing to the ecosystem-based optimization tools and services built upon it.\nThe VWT prototype was unveiled at Singapore Maritime Week 2024, demonstrating how real-time, primary data sharing can drive early warning signals for disruptions, improve cargo visibility, and enable collaborative decision-making. The federated model allows each participant to retain control over their data while contributing to a collective intelligence that benefits all.\nReal-Life Value Creation: Movement in the Field\nThe value of Movement by project44 is best understood through the lens of its customers. Blue Diamond Growers, an agricultural cooperative, partnered with SAP, project44, and XpertMinds to transform its supply chain, resulting in $1 million in transportation cost savings. Features such as geofencing, predictive ETAs (estimated times of arrival), and exception dashboards enabled productivity gains, enhanced service, and improved customer communication. According to project44, demurrage costs dropped, on-time shipping rates improved, and receipt plans increased. The operations team saw a 60% reduction in customer outreach, freeing up resources for strategic tasks. In manufacturing, real-time visibility is critical for just-in-time operations. Magna, servicing customers like BMW and Daimler, used project44 to coordinate millions of assets across numerous origins, achieving a 40% increase in on-time deliveries.These examples illustrate the solution’s core strengths: actionable intelligence, automation, and measurable return on investment (ROI). This is similar to what VWT is promising.\nReal-Life Value Creation: The Virtual Watch Tower in Action\nThe VWT’s value is equally concrete, though it emerges from a different logic. VWT is an ecosystem of actors who co-create what constitutes the community and its digital architecture VWTnet. In its vision video, ten containers were destined for Australia, moving from a factory by rail to Oulu in Finland, then by feeder ship to Zeebrugge, and onward to Sydney via Singapore. Along the way, a storm delayed the feeder ship. In the past, each actor—namely, the shipper, port, and carrier—operated on partial information, risking missed connections and cascading delays. With VWT, the ship’s operations center in Copenhagen, the captain, and the port control room in Zeebrugge all accessed the same real-time data. The VWT’s machine-powered recommendation prompted the captain to increase speed, ensuring the containers made their connection. This is an example of data-empowered collaboration.\nIn 2023, the VWT began as an applied research project and is now transitioning into operations, with the establishment of a not-for-profit structure and the finalization of a first minimum viable product (MVP). According to the VWT roadmap, VWTnet is based on TWIN and the world’s first distributed solution for primary shipment data sharing  is scheduled to be live in 2026. The VWT community aims to develop and add to the infrastructure innovative and unprecedented tools for primary data-sharing. Transporeon, Chasqee, Roambee, and Strategy Object are supporting the development of such digital capabilities.\nPhilosophical and Structural Differences\nThe contrast between Movement and the VWT is not just technical; it is philosophical. Movement is a proprietary, vendor-led platform designed to deliver value to paying customers through execution-focused AI and unified workflows. Movement’s governance is centralized, driven by customer needs, the company’s interests, and its vision.\nThe VWT, by contrast, is a federated infrastructure, governed by the board of trustees. It is not a product to be bought, but a public good to be stewarded. Its value is not limited to individual enterprises but accrues to the entire ecosystem, enabling new services, business models, and forms of collaboration. Its governance is open, transparent, and inclusive, with strategic oversight by a neutral construct and technical co-development by a global network of contributing co-stewards of the public good.\nThis difference matters. The discontinuation of TradeLens, a well-funded but ultimately unsustainable industry platform, underscored the lesson that technology alone is insufficient without widespread collaboration and trust and that commercial interest can stand in the way of the adoption of innovative industry solutions. The VWT’s success lies in its ability to potentially bring together every shipper, carrier, port, authority, and technology provider, irrespective of whether partners or peers, in a shared collaborative and digital space, orchestrated by a neutral team, and governed by collective principles rather than proprietary interests.\nThe Role of AI: Automation versus Augmentation\nBoth Movement and the VWT harness AI, but their approaches differ. Movement’s AI agents are designed to automate and optimize resource-intensive tasks, including resolving data gaps, predicting disruptions, and recommending and executing actions. The goal is self-optimized logistics, an autonomous supply chain that minimizes manual intervention and maximizes efficiency.\nThe VWT utilizes third-party AI, offered in the “VWTnet App Space”, to augment human decision-making, rather than replace it. The analytics provide descriptive, predictive, and prescriptive insights, but always in the context of collaborative, cross-organizational workflows to augment each actor’s intelligence. The VWT’s “virtual situation rooms” with collective intelligence bring together stakeholders to interpret data, debate options, and coordinate responses. AI is an enabler, not a substitute for trust and dialogue.\nThis distinction is not academic. In the Oulu–Australia corridor example, the VWT’s recommendation engine suggested a speed adjustment, but the decision was made collaboratively by the captain and operations center in Copenhagen, informed by the shared primary data and collective expertise. The VWT’s strength lies in its ability to align diverse actors on equal footing around shared situational awareness, enabling coordinated, context-sensitive action.\nGovernance and Ecosystem Impact\nMovement’s governance is proprietary. Project44 owns the platform, sets the rules, and drives innovation. The value accrues to its customers, who are enterprises seeking a competitive edge through automation and intelligence.\nThe VWT’s governance is federated and inclusive. Its future charity structure ensures neutrality and transparency, while its two-tier model separates strategic oversight from technical co-development. All stakeholders—shippers, carriers, ports, authorities, tech firms—participate in co-design, protocol updates, and decision-making. The result is a platform that evolves in response to the community's needs, rather than being decided by a single vendor.\nThis model has attracted support from public and private sector actors, research institutes, and industry alliances. Customs authorities, environmental agencies, and trade negotiators see the VWT as a potential backbone for digital corridors, green corridors, and trade facilitation programs. Its open standards and modular adapters allow it to bridge legacy systems and national protocols, enabling interoperability without imposing new standards, but building on existing ones, such as the DCSA, the Digital Container Shipping Association’s set of standards.\nThe Industry as a Whole: Fragmentation or Federation?\nThe stakes are high. The supply chain industry has long suffered from fragmentation, data silos, and reactive management. Proprietary platforms, such as Movement, offer a path to greater efficiency, automation, and measurable ROI for individual enterprises. However, they may risk reinforcing the very silos they seek to overcome, as each actor adopts its own solution, optimized for its own needs. This self-centered approach has traditionally led to suboptimal outcomes.\nThe VWT offers a different vision: an industry-guided federated backbone that can connect all actors, enabling shared situational awareness, collaborative disruption management, and ecosystem-level innovation. Its value is not limited to any single company but accrues to the entire industry, fostering trust, transparency, and resilience.\nLessons Learned and the Road Ahead\nThe story of Movement and the VWT is not one of competition but of complementarity. Both solutions address real needs: Movement delivers actionable intelligence and automation for enterprises seeking efficiency and control; the VWT provides a neutral, federated backbone for ecosystem-wide collaboration and innovation, aiming for broader adoption.\nThe VWT’s destiny lies in its ability to bring together diverse actors in a shared digital collaborative space, governed by collective principles and open standards. Its federated model enables organic growth, as each new shipment seeds further connections across the chain.\nAt the same time, the supply chain and logistics industry needs platforms like Movement to drive execution and automate routine tasks. The future may well lie in the convergence of these models: proprietary platforms delivering value to enterprises, federated backbones enabling ecosystem-wide collaboration.\nConclusion: Building the Supply Chain of the Future\nThe launch of Movement by project44 is a testament to the evolution of supply chain technology. Its AI-powered, execution-focused platform delivers real value to enterprises, automating tasks, reducing costs, and improving customer experience. But as the industry looks to the future, the lessons of the Virtual Watch Tower are equally important. The supply chain is not just a collection of individual actors but a complex, interdependent ecosystem. Its resilience depends not only on technology but also on trust, governance, and a shared purpose.\nThe choice is not either/or. The industry needs both: strong execution power and federated approaches. The urgent need is to build bridges—technical, organizational, and cultural—between these worlds, creating a supply chain that is not only efficient and automated but also resilient, transparent, and inclusive.\nThe supply chain networks of the future will not be built by any single company or platform. They will be co-created by the collaborating actors, shaped by shared interests and goals. The leading networks will be those that are based on a shared vision and common values and sustained by trust. The journey has begun. The question is: who will join the leaders, and how far will we go together?\nMikael Lind is the world’s first (adjunct) Professor of Maritime Informatics engaged at Chalmers and Research Institutes of Sweden (RISE). He is a well-known expert frequently published in international trade press, is co-editor of the first two books on Maritime Informatics, and is co-editor of the book Maritime Decarbonization.\nWolfgang Lehmacher is a global supply chain expert, partner at Anchor Group, and advisor at Topan AG. The former director at the World Economic Forum and CEO Emeritus of GeoPost Intercontinental is an advisory board member of The Logistics and Supply Chain Management Society, an ambassador for F&L, and an advisor to Global:SF and RISE. He contributes to the knowledge base of Maritime Informatics and is a co-editor of the book Maritime Decarbonization.\nXiuju Fu is Maritime AI Programme Director and senior principal scientist at Institute of High Performance Computing, Agency for Science Technology and Research (ASTAR), Singapore and active in developing and applying AI, big data intelligence, simulation, and optimization techniques for complex system management. Currently, she is leading Maritime AI Programme in Singapore for research in maritime data excellence, maritime AI modelling excellence, maritime AI computing and application excellence.\nJens Lund-Nielsen (IOTA Foundation) is an expert advisor to the UK Parliament, World Economic Forum and multiple corporations. Previous employers include A. P. Moller - Maersk and pwc. Jens is a pioneer in building public-private partnerships to enable better trade for all, including co-founder of the Global Alliance for Trade Facilitation (www.trade facilitation.org) and the Logistics Emergency Teams with World Food Programme.\nFootnotes\n[i] A Basu Bal, ‘Technology-Mediated Organisation of Transport Actors: Laytime in Perspective’ (2023) 29(6) Journal of International Maritime Law 346–365.\nA Basu Bal, ‘The Emerging Interface of Digital Innovation and Sustainability in Transport’ (2024) 24(7) Lloyd’s Shipping & Trade Law 1–4.\nThe opinions expressed herein are the author's and not necessarily those of The Maritime Executive.\nBAE Systems Ordered to Improve Fire Safety at Nuclear-Sub Shipyard\nGas Power is Making China Dependent on LNG Shipping\nTechnology Leaders\nBarstad: Owner of Shadow Fleet Tanker Couldn't Be Found After Collision\nTwo New Chapters in Supply Chain Data-Driven Intelligence\nGas Power is Making China Dependent on LNG Shipping\nOp-Ed: U.S. Seabed Mining Order Could Undermine Protections for Antarctica\nStudy: Mass Extinction Events Scramble Ocean Biodiversity\nDiversifying Threats to Maritime Security in the Western Indian Ocean\nSUBSCRIPTIONS\nSUBSCRIBE\nBusiness\n\nTwo New Chapters in Supply Chain Data-Driven Intelligence\nPublished\nJun 18, 2025 11:35 PM by\nMikael Lind et al.\n[By Mikael Lind, Wolfgang Lehmacher, Xiuju Fu, Jens Lund-Nielsen]\nYears of extreme volatility, caused by pandemic shocks, trade wars, and climate-driven disruptions, have exposed the complexity of the world’s logistics networks. Thanks to the increasing availability of multi-source data and rapid advancements in AI technologies, we now have unprecedented opportunities to unravel the complexities of supply chain operations. By harnessing collective intelligence, organizations can drive both cost efficiencies and significant reductions in emissions.\nThe unveiling of project44’s next-generation Movement...\nGovernment\n\nFrench Shipping Magnate Philippe Louis-Dreyfus Passes at 80\nPublished\nJun 18, 2025 10:57 PM by\nThe Maritime Executive\nPhilippe Louis-Dreyfus, a giant name in European shipping, has passed away at the age of 80. He leaves behind a legacy of contributions to France and to the global industry.\nPhilippe Louis-Dreyfus spent the first decades of his professional career in shipping finance, with executive roles at his family's Banque Louis Dreyfus, then at Banque Pallas France and Credit Naval. In 1996, he took over management of Louis Dreyfus Armateurs, expanding it into the subsea cable-lay market through the...\nGovernment\n\nFormer NOAA Officials Call on Industry to Oppose Budget Cuts\nPublished\nJun 18, 2025 9:43 PM by\nThe Maritime Executive\nThe National Oceanic and Atmospheric Administration faces a new round of budget cuts that would undermine the agency's ability to provide services that millions of Americans need, including hurricane research and weather forecasting, according to a group of former top officials. \nThe White House's proposed FY2026 budget calls for cuts totaling $1.3 billion across all NOAA programs, with particularly steep reductions targeting the National Marine Fisheries Service and NOAA's research division. The proposed cuts follow the loss of hundreds...\nTugs & Salvage\n\nMaritime NZ Charges KiwiRail Over Ro/Ro Grounding\nPublished\nJun 18, 2025 8:51 PM by\nThe Maritime Executive\nNew Zealand’s inter-island ro/ro ferry operator KiwiRail is facing charges following accusations of endangering the safety of passengers after one of its ferries grounded in June last year.\nMaritime NZ said it has filed two charges against KiwiRail after completing investigations on the grounding of ro/ro ferry Aratere north of Picton on June 21, 2024. At the time of the incident, the ferry had 47 people on board. Luckily, all the passengers and crew were safely returned to shore with the ferry...\nSUBSCRIPTIONS\nSUBSCRIBE\n\n© Copyright 2025 The Maritime Executive, LLC. All rights reserved.",
        }
    ]


@pytest.fixture
def mock_settings(monkeypatch):
    """Fixture to patch the settings to use tavily as the search provider."""
    monkeypatch.setattr("src.utils.search.settings.SEARCH_PROVIDER", "tavily")
    monkeypatch.setattr("src.utils.search.settings.INCLUDE_WIKIPEDIA", False)
    yield


@pytest.fixture
def mock_search(monkeypatch, mock_search_result):
    """Fixture to patch the search function."""

    def mock_search_func(*args, **kwargs):
        return mock_search_result, True

    # Patch the search function
    with patch("src.utils.search._tavily_search", side_effect=mock_search_func) as mock:
        yield mock


@pytest.fixture
def mock_key_points(monkeypatch):
    """Fixture to patch the extract_key_points function."""

    key_points = [
        "Years of extreme volatility from pandemic shocks, trade wars, and climate disruptions have exposed the complexity of global logistics networks.",
        "Advances in multi-source data and AI technologies present new opportunities to understand and optimize supply chain operations.",
        "Organizations can leverage collective intelligence to achieve cost efficiencies and reduce emissions.",
        'project44\'s Movement platform introduces "Decision Intelligence," an AI-powered engine transforming logistics data into automated, actionable outcomes, focusing on management, rerouting, and exception automation.',
        "Movement's architecture involves four layers: Connect, See, Act, and Automate, emphasizing execution and automation using AI Data Quality Agents, Disruption Navigator, and Supply Chain Assistant.",
        "Customers like Ford and Eaton report benefits such as faster decision-making, expanded visibility, and improved operational efficiency, leading to measurable ROI.",
    ]

    response_info = ResponseInfo(
        consumed_tokens=5354,
        total_cost=0.0007079,
        prompt_name="extract_news_key_points",
        model_name="openai:gpt-4.1-nano",
        error=None,
    )

    return ExtractKeyPointsResponse(
        points=key_points, response_info=response_info.model_dump()
    )


@pytest.fixture
def mock_base_chain_invoke(mock_key_points):
    """Fixture to patch the BaseChain.invoke method."""

    async def mock_invoke(*args, **kwargs):
        return mock_key_points

    with patch("src.chains.base.BaseChain.invoke", side_effect=mock_invoke) as mock:
        yield mock


@pytest.mark.integration
@pytest.mark.asyncio
async def test_enrich_context_basic(test_request):
    response = await enrich_context(test_request)
    assert response.sector_summary
    assert isinstance(response.key_points, list)
    assert isinstance(response.source_table, list)


@pytest.mark.asyncio
async def test_enrich_context_with_mock(
    test_request, mock_settings, mock_search, mock_base_chain_invoke
):
    """Test enrich_context with mocked search results and key points extraction."""

    response = await enrich_context(test_request)

    # Verify the results
    assert len(response.source_table) > 0
    assert (
        response.source_table[0]["title"]
        == "Two New Chapters in Supply Chain Data-Driven Intelligence - The Maritime Executive"
    )
